name: Bump Patch Version

on:
  push:
    branches:
      - main

jobs:
  bump-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
            fetch-depth: 0  # důležité pro získání všech tagů
            persist-credentials: false

      - name: Sync pom.xml version with latest tag
        shell: bash
        run: |
            TAG=$(git describe --tags --abbrev=0)
            VERSION=${TAG#v}
            echo "Aktuální tag: $TAG → verze: $VERSION"
            sed -i "s|<version>.*</version>|<version>${VERSION}</version>|" backend/pom.xml
            echo "✅ pom.xml aktualizován"

      - name: Bump patch version
        shell: bash
        env:
            GH_PAT: ${{ secrets.GH_PAT }}
        run: |
            git fetch --tags
            LAST_TAG=$(git describe --tags --abbrev=0 || echo "v0.0.0")
            PATCH=$(( ${LAST_TAG##*.} + 1 ))
            NEW_TAG="${LAST_TAG%.*}.$PATCH"
            echo "New tag: $NEW_TAG"
            git config user.name "github-actions"
            git config user.email "github-actions@github.com"
            # GitHub přijímá formát: x-access-token:<PAT>
            git config credential.helper store
            echo "https://x-access-token:${GH_PAT}@github.com" > ~/.git-credentials
            git tag $NEW_TAG
            git push origin $NEW_TAG
            
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Build with Maven
        working-directory: backend
        run: mvn -B clean package
         
      - name: Run unit tests
        working-directory: backend
        run: mvn test

      - name: Upload build artifact
        uses: actions/upload-artifact@v3
        with:
          name: backend-jar
          path: backend/target/*.jar
